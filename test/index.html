<html>
<head>
<title>JavaScript Zip Testing</title>
<link media="screen" href="../lib/testsuite.css" type="text/css" rel="stylesheet">
<script src="../javascript-zip.js"></script>
<script src="../lib/jquery-1.3.2.min.js"></script>
<script src="../lib/testrunner.js"></script>
<script>

function similar(actual, expected, mistakes)
{
   if (actual.length !== expected.length) mistakes--;

   for (var i = 0; i < Math.min(actual.length, expected.length); i++)
   {
      if (actual[i] !== expected[i]) mistakes--;
   }

   //QUnit.push(mistakes >= 0, actual, expected, message);
   if (mistakes < 0)
      throw Math.abs(mistakes)+" too many mistakes";
   else
      return true;
}

$(document).ready(function(){

   test("JSZip", function(){
      ok(JSZip, "JSZip exists");

      var zip = new JSZip();
      ok(zip, "Constructor works");
   });

   test("Text file zip", function()
   {
      // If anyone can work out how to get binary data over AJAX without it
      // being mangled by UTF-8 transforms, I would be very grateful
      var expected = "UEsDBAoDAAAAAJx08Trj5ZWwDAAAAAwAAAAJAAAASGVsbG8udHh0SGVsbG8gV29ybGQKUEsBAhQDCgMAAAAAnHTxOuPllbAMAAAADAAAAAkAAAAAAAAAAAAggKSBAAAAAEhlbGxvLnR4dFBLBQYAAAAAAQABADcAAAAzAAAAAAA=";

      var zip = new JSZip();
      zip.add("Hello.txt", "Hello World\n");
      content = zip.generate();

      var actual = Base64.decode(content);
      expected = Base64.decode(expected);

      /*
      Expected differing bytes:
      2  version number
      4  date/time
      4  central dir version numbers
      4  central dir date/time
      4  external file attributes

      18 Total
      */
      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");

   });


   test("Image file zip", function()
   {
      var expected = "UEsDBAoDAAAAABVv6jo8P+uKKQAAACkAAAAJAAAAc21pbGUuZ2lmR0lGODdhBQAFAIACAAAAAP/eACwAAAAABQAFAAACCIwPkWerClIBADtQSwECFAMKAwAAAAAVb+o6PD/riikAAAApAAAACQAAAAAAAAAAACCApIEAAAAAc21pbGUuZ2lmUEsFBgAAAAABAAEANwAAAFAAAAAAAA=="

      var zip = new JSZip();
      zip.add("smile.gif", "R0lGODdhBQAFAIACAAAAAP/eACwAAAAABQAFAAACCIwPkWerClIBADs=", {base64: true});
      content = zip.generate();

      actual = Base64.decode(content);
      expected = Base64.decode(expected);

      /*
      Expected differing bytes:
      2  version number
      4  date/time
      4  central dir version numbers
      4  central dir date/time
      4  external file attributes

      18 Total
      */
      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");

   });

/*
   test("Add a directory", function()
   {
      dir = zip.dir("directory");
      dir.add("directoryFile.txt", "Success");
   });
*/

});

</script>
</head>
<body>
   <h1>CssGridGen Testing</h1>
   <h2 id="banner"></h2>
   <h2 id="userAgent"></h2>
   <ol id="tests"></ol>
   <div id="main"></div>
</body>
</html>
