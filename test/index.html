<!DOCTYPE html>
<html>
<head>
<title>JavaScript Zip Testing</title>
<link media="screen" href="qunit.css" type="text/css" rel="stylesheet">
<script type="text/javascript" src="../jszip.js"></script>
<script type="text/javascript" src="../jszip-load.js"></script>
<script type="text/javascript" src="../jszip-deflate.js"></script>
<script type="text/javascript" src="../jszip-inflate.js"></script>
<script type="text/javascript" src="qunit.js"></script>
<script type="text/javascript">

function similar(actual, expected, mistakes)
{
   if (actual.length !== expected.length) mistakes--;

   for (var i = 0; i < Math.min(actual.length, expected.length); i++)
   {
      if (actual[i] !== expected[i]) mistakes--;
   }

   if (mistakes < 0)
      return false;
   else
      return true;
}

function reload(bytesStream)
{
  var content = new JSZip(bytesStream).generate();
  var actual = JSZipBase64.decode(content);
  return actual;
}

   var refZips = [];
   refZips["text"]=JSZipBase64.decode("UEsDBAoDAAAAAJx08Trj5ZWwDAAAAAwAAAAJAAAASGVsbG8udHh0SGVsbG8gV29ybGQKUEsBAhQDCgMAAAAAnHTxOuPllbAMAAAADAAAAAkAAAAAAAAAAAAggKSBAAAAAEhlbGxvLnR4dFBLBQYAAAAAAQABADcAAAAzAAAAAAA=");
   refZips["utf8"]=JSZipBase64.decode("UEsDBAoAAAAAAJp95Tx8M2u8CgAAAAoAAAAKAAAAYW1vdW50LnR4dMOi4oCawqwxNQpQSwECFAAKAAAAAACafeU8fDNrvAoAAAAKAAAACgAAAAAAAAAAAAAAAAAAAAAAYW1vdW50LnR4dFBLBQYAAAAAAQABADgAAAAyAAAAAAA=");
   refZips["image"]=JSZipBase64.decode("UEsDBAoDAAAAABVv6jo8P+uKKQAAACkAAAAJAAAAc21pbGUuZ2lmR0lGODdhBQAFAIACAAAAAP/eACwAAAAABQAFAAACCIwPkWerClIBADtQSwECFAMKAwAAAAAVb+o6PD/riikAAAApAAAACQAAAAAAAAAAACCApIEAAAAAc21pbGUuZ2lmUEsFBgAAAAABAAEANwAAAFAAAAAAAA==");
   refZips["folder"]=JSZipBase64.decode("UEsDBAoDAAAAAANt8zoAAAAAAAAAAAAAAAAHAAAAZm9sZGVyL1BLAQIUAwoDAAAAAANt8zoAAAAAAAAAAAAAAAAHAAAAAAAAAAAAEIDtQQAAAABmb2xkZXIvUEsFBgAAAAABAAEANQAAACUAAAAAAA==");
   refZips["all"]=JSZipBase64.decode("UEsDBAoDAAAAAJxs8Trj5ZWwDAAAAAwAAAAJAAAASGVsbG8udHh0SGVsbG8gV29ybGQKUEsDBAoDAAAAALFs8ToAAAAAAAAAAAAAAAAHAAAAaW1hZ2VzL1BLAwQKAwAAAAAVZ+o6PD/riikAAAApAAAAEAAAAGltYWdlcy9zbWlsZS5naWZHSUY4N2EFAAUAgAIAAAAA/94ALAAAAAAFAAUAAAIIjA+RZ6sKUgEAO1BLAQIUAwoDAAAAAJxs8Trj5ZWwDAAAAAwAAAAJAAAAAAAAAAAAIICkgQAAAABIZWxsby50eHRQSwECFAMKAwAAAACxbPE6AAAAAAAAAAAAAAAABwAAAAAAAAAAABCA7UEzAAAAaW1hZ2VzL1BLAQIUAwoDAAAAABVn6jo8P+uKKQAAACkAAAAQAAAAAAAAAAAAIICkgVgAAABpbWFnZXMvc21pbGUuZ2lmUEsFBgAAAAADAAMAqgAAAK8AAAAAAA==");
   refZips["STORE-text"]=JSZipBase64.decode("UEsDBAoAAAAAANRxmDyTTw7hXgAAAF4AAAAJAAAASGVsbG8udHh0VGhpcyBhIGxvb29uZyBmaWxlIDogd2UgbmVlZCB0byBzZWUgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGUgZGlmZmVyZW50IGNvbXByZXNzaW9uIG1ldGhvZHMuClBLAQIeAwoAAAAAANRxmDyTTw7hXgAAAF4AAAAJAAAAAAAAAAAAAACkgQAAAABIZWxsby50eHRQSwUGAAAAAAEAAQA3AAAAhQAAAAAA");
   refZips["DEFLATE-text"]=JSZipBase64.decode("UEsDBBQAAAAIANRxmDyTTw7hSQAAAF4AAAAJAAAASGVsbG8udHh0VcixDYAwDATAnil+AgZgDhaA+EMsJTaKLWV9aq68s2ngQnd3e1C1EwcWYaQgHUEiGyFaKyetEDdzkfbrRPHxTkaoGwazucS+fVBLAQIeAxQAAAAIANRxmDyTTw7hSQAAAF4AAAAJAAAAAAAAAAEAAACkgQAAAABIZWxsby50eHRQSwUGAAAAAAEAAQA3AAAAcAAAAAAA");

   test("JSZip", function(){
      ok(JSZip, "JSZip exists");

      var zip = new JSZip();
      ok(zip, "Constructor works");
   });

   module("Essential");

   test("Zip text file", function()
   {
      // If anyone can work out how to get binary data over AJAX without it
      // being mangled by UTF-8 transforms, I would be very grateful
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      /*
      Expected differing bytes:
      2  version number
      4  date/time
      4  central dir version numbers
      4  central dir date/time
      4  external file attributes

      18 Total
      */
      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });

   test("Add a file to overwrite", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.file("Hello.txt", "hello ?");
      zip.file("Hello.txt", "Hello World\n");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      /*
      Expected differing bytes:
      2  version number
      4  date/time
      4  central dir version numbers
      4  central dir date/time
      4  external file attributes

      18 Total
      */
      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });

   test("Zip text file with UTF-8 characters", function()
   {
      var expected = refZips["utf8"];

      var zip = new JSZip();
      zip.file("amount.txt", "â‚¬15\n");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });

   test("Zip text file with date", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
	  zip.file("Hello.txt", "Hello World\n", {date : new Date("July 17, 2009 14:36:57")});
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      /*
      Expected differing bytes:
      2  version number
      4  central dir version numbers
      4  external file attributes

      10 Total
      */
      ok(similar(actual, expected, 10) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });


   test("Zip image file", function()
   {
      var expected = refZips["image"];

      var zip = new JSZip();
      zip.file("smile.gif", "R0lGODdhBQAFAIACAAAAAP/eACwAAAAABQAFAAACCIwPkWerClIBADs=", {base64: true});
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });

   test("Zip empty folder", function()
   {
      var expected = refZips["folder"];

      var zip = new JSZip();
      zip.folder("folder");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });

   test("Zip text, folder and image", function()
   {
      var expected = refZips["all"];

      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      zip.folder("images").file("smile.gif", "R0lGODdhBQAFAIACAAAAAP/eACwAAAAABQAFAAACCIwPkWerClIBADs=", {base64: true});
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      /*
      Expected differing bytes:
      2  version number
      4  date/time
      4  central dir version numbers
      4  central dir date/time
      4  external file attributes

      18 * 3 files
      54 Total
      */

      //console.log("data:application/zip;base64,"+content);
      ok(similar(actual, expected, 54) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });

   test("Finding a file", function()
   {
      var zip = new JSZip();
      zip.file("Readme", "Hello World!\n");
      zip.file("Readme.French", "Bonjour tout le monde!\n");
      zip.file("Readme.Pirate", "Ahoy m'hearty!\n");

      equals(zip.file("Readme.French").data, "Bonjour tout le monde!\n", "Exact match found");
      equals(zip.file("Readme.Deutch"), null, "Match exactly nothing");
      equals(zip.file(/Readme\../).length, 2, "Match regex free text");
      equals(zip.file(/pirate/i).length, 1, "Match regex 1 result");
   });

   test("Finding a file : modifying the result doesn't alter the zip", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      zip.file("Hello.txt").data = "new data";
      zip.file("Hello.txt").name = "Hello2.txt";
      zip.file("Hello.txt").options.dir = true;
      // these changes won't be used
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
   });

   test("Finding a file (text search) with a relative folder", function()
   {
      var zip = new JSZip();
      zip.folder("files/default").file("Readme", "Hello World!\n");
      zip.folder("files/translation").file("Readme.French", "Bonjour tout le monde!\n");
      zip.folder("files").folder("translation").file("Readme.Pirate", "Ahoy m'hearty!\n");

      equals(zip.file("files/translation/Readme.French").data, "Bonjour tout le monde!\n", "finding file with the full path");
      equals(zip.folder("files").file("translation/Readme.French").data, "Bonjour tout le monde!\n", "finding file with a relative path");
      equals(zip.folder("files/translation").file("Readme.French").data, "Bonjour tout le monde!\n", "finding file with a relative path");
   });

   test("Finding files (regex) with a relative folder", function()
   {
      var zip = new JSZip();
      zip.folder("files/default").file("Readme", "Hello World!\n");
      zip.folder("files/translation").file("Readme.French", "Bonjour tout le monde!\n");
      zip.folder("files").folder("translation").file("Readme.Pirate", "Ahoy m'hearty!\n");

      equals(zip.file(/Readme/).length, 3, "match files in subfolders");
      equals(zip.folder("files/translation").file(/Readme/).length, 2, "regex match only in subfolders");
      equals(zip.folder("files").folder("translation").file(/Readme/).length, 2, "regex match only in subfolders");
      equals(zip.folder("files/translation").file(/pirate/i).length, 1, "regex match only in subfolders");
      equals(zip.folder("files/translation").file(/^readme/i).length, 2, "regex match only with the relative path");
      equals(zip.folder("files/default").file(/pirate/i).length, 0, "regex match only in subfolders");
   });

   test("Finding folders", function ()
   {
      var zip = new JSZip();
      zip.folder("root/").folder("sub1/");
      zip.folder("root/sub2/subsub1");

      equals(zip.folder(/sub2\/$/).length, 1, "unique result");
      equals(zip.folder(/sub1/).length, 2, "multiple results");
      equals(zip.folder(/root/).length, 4, "match on whole path");
   });

   test("Finding folders with relative path", function () {
      var zip = new JSZip();
      zip.folder("root/").folder("sub1/");
      zip.folder("root/sub2/subsub1");
      var root = zip.folder("root/sub2");

      equals(root.folder(/sub2\/$/).length, 0, "current folder is not matched");
      equals(root.folder(/sub1/).length, 1, "sub folder is matched");
      equals(root.folder(/^subsub1/).length, 1, "relative folder path is used");
      equals(root.folder(/root/).length, 0, "parent folder is not matched");
   });

   module("More advanced");

   test("Delete file", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.file("Remove.txt", "This file should be deleted\n");
      zip.file("Hello.txt", "Hello World\n");
      zip.remove("Remove.txt");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");

   });

   test("Delete file in folder", function()
   {
      var expected = refZips["folder"];

      var zip = new JSZip();
      zip.folder("folder").file("Remove.txt", "This folder and file should be deleted\n");
      zip.remove("folder/Remove.txt");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
   });

   test("Delete file in folder, with a relative path", function()
   {
      var expected = refZips["folder"];

      var zip = new JSZip();
      var folder = zip.folder("folder");
      folder.file("Remove.txt", "This folder and file should be deleted\n");
      folder.remove("Remove.txt");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
   });

   test("Delete folder", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.folder("remove").file("Remove.txt", "This folder and file should be deleted\n");
      zip.file("Hello.txt", "Hello World\n");
      zip.remove("remove");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");

   });

   test("Delete nested folders", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.folder("remove").file("Remove.txt", "This folder and file should be deleted\n");
      zip.folder("remove/second").file("Sub.txt", "This should be removed");
      zip.file("remove/second/another.txt", "Another file");
      zip.file("Hello.txt", "Hello World\n");
      zip.remove("remove");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");

   });

   test("Delete nested folders from relative path", function()
   {
      var expected = refZips["folder"];

      var zip = new JSZip();
      zip.folder("folder");
      zip.folder("folder/1/2/3");
      zip.folder("folder").remove("1");
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
      equals(reload(actual), actual, "Generated ZIP can be parsed");
   });

   test("Byte string output", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      var content = zip.generate({base64:false});

      var actual = content;
      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
   });

   test("Filtering a zip", function()
   {
     var zip = new JSZip();
     zip.file("1.txt", "1\n");
     zip.file("2.txt", "2\n");
     zip.file("3.log", "3\n");
     var result = zip.filter(function (relativeFilename, file){
       return relativeFilename.indexOf(".txt") != -1;
     });
     equals(result.length, 2, "filter has filtered");
     ok(result[0].name.indexOf(".txt") != -1, "filter has filtered the good file");
     ok(result[1].name.indexOf(".txt") != -1, "filter has filtered the good file");
   });

   test("Filtering a zip from a relative path", function()
   {
     var zip = new JSZip();
     zip.file("foo/1.txt", "1\n");
     zip.file("foo/2.txt", "2\n");
     zip.file("foo/3.log", "3\n");
     zip.file("1.txt", "1\n");
     zip.file("2.txt", "2\n");
     zip.file("3.log", "3\n");

     var result = zip.folder("foo").filter(function (relativeFilename, file){
       return relativeFilename.indexOf("3") != -1;
     });
     equals(result.length, 1, "filter has filtered");
     equals(result[0].name, "foo/3.log", "filter has filtered the good file");
   });

   test("Filtering a zip : the full path is still accessible", function()
   {
     var zip = new JSZip();
     zip.file("foo/1.txt", "1\n");
     zip.file("foo/2.txt", "2\n");
     zip.file("foo/3.log", "3\n");
     zip.file("1.txt", "1\n");
     zip.file("2.txt", "2\n");
     zip.file("3.log", "3\n");

     var result = zip.folder("foo").filter(function (relativeFilename, file){
       return file.name.indexOf("3") != -1;
       return file.name.indexOf("3") != -1 && file.name.indexOf("foo") != -1;
     });
     equals(result.length, 1, "the filter only match files/folders in the current folder");
     equals(result[0].name, "foo/3.log", "filter has filtered the good file");
   });

   test("Filtering a zip : the filter function can't alter the data", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      zip.filter(function (relativeFilename, file) {
        file.name = "bye.txt";
        file.data = "good bye";
        file.options.dir = true;
      });
      var content = zip.generate();

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");

   });

   test("STORE is the default method", function()
   {
      var expected = refZips["text"];

      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      var content = zip.generate({compression:'STORE'});

      var actual = JSZipBase64.decode(content);

	  // no difference with the "Zip text file" test.
      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
   });

   test("STORE doesn't compress", function()
   {
      var expected = refZips["STORE-text"]; // zip -0 -X store.zip Hello.txt

      var zip = new JSZip();
      zip.file("Hello.txt", "This a looong file : we need to see the difference between the different compression methods.\n");
      var content = zip.generate({compression:'STORE'});

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
   });


   test("DEFLATE compress", function()
   {
      var expected = refZips["DEFLATE-text"]; // zip -6 -X deflate.zip Hello.txt

      var zip = new JSZip();
      zip.file("Hello.txt", "This a looong file : we need to see the difference between the different compression methods.\n");
      var content = zip.generate({compression:'DEFLATE'});

      var actual = JSZipBase64.decode(content);

      ok(similar(actual, expected, 18) , "Generated ZIP matches reference ZIP");
   });



</script>
</head>
<body>

	<h1 id="qunit-header">JSZip Testing</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
</body>
</html>
